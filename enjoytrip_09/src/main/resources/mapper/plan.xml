<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.enjoytrip.member.plan.mapper.PlanMapper">

	<resultMap type="planDto" id="plan">
		<result column="plan_id" property="planId" />
		<result column="user_id" property="userId" />
		<result column="user_nickname" property="userNickname" />
		<result column="plan_title" property="planTitle" />
		<result column="update_time" property="updateTime" />
		<result column="image" property="img" />
	</resultMap>

	<resultMap type="planSeqDto" id="planSeqs">
		<result column="plan_id" property="planId" />
		<result column="plan_date" property="planDate" />
		<result column="plan_seq" property="planSeq" />
		<result column="content_id" property="contentId" />
		<result column="title" property="title" />
		<result column="first_image" property="img" />
		<result column="overview" property="overview" />
	</resultMap>

	<insert id="registPlan" parameterType="planDto">
		insert into plan_list (user_id, plan_id, plan_title, update_time)
		value(#{userId}, #{planId}, #{planTitle}, now())
	</insert>
	
	<insert id="registPlanSeqs" parameterType="planDto">
		insert into plan_seq (plan_id, plan_date, plan_seq, content_id)
		values
		    <foreach collection="planSeqs" item="seq" separator=" , ">
				(#{planId}, #{seq.planDate}, #{seq.planSeq}, #{seq.contentId})
			</foreach>
	</insert>
	
	<update id="modifyPlan" parameterType="planDto">
		update plan_list
		set plan_title = #{planTitle},
		    update_time = now()
		where plan_id = #{planId}
	</update>

	<delete id="deletePlan" parameterType="String">
		delete from plan_list
		where plan_id = #{planId}
	</delete>
	
	<delete id="deletePlanSeqs" parameterType="String">
		delete from plan_seq
		where plan_id = #{planId}
	</delete>

	<select id="listPlan" resultMap="plan">
		select l.plan_id, l.user_id, m.user_nickname, l.plan_title, l.update_time
			   (select a.first_image
				from plan_seq s join attraction_info a
									 on s.content_id = a.content_id
				where l.plan_id = s.plan_id
				  and a.first_image != ""
		order by s.plan_date, s.plan_seq
			limit 1) as image
		from plan_list l join trip_member m
		on l.user_id = m.user_id;
	</select>

	<select id="searchListByTitle" parameterType="String" resultMap="plan">
		select l.plan_id, l.user_id, m.user_nickname, l.plan_title, l.update_time
			   (select a.first_image
				from plan_seq s join attraction_info a
									 on s.content_id = a.content_id
				where l.plan_id = s.plan_id
				  and a.first_image != ""
		order by s.plan_date, s.plan_seq
			limit 1) as image
		from plan_list l join trip_member m
		on l.user_id = m.user_id
		where l.plan_title like concat('%', #{word}, '%')
	</select>

	<select id="getPlan" parameterType="String" resultMap="plan">
		select l.plan_id, l.user_id, m.user_nickname, l.plan_title, l.update_time
		from plan_list l join trip_member m
		on l.user_id = m.user_id
		where plan_id = #{planId}
	</select>

	<select id="getPlanSeqs" parameterType="String" resultMap="planSeqs">
		select s.plan_date, s.plan_seq, a.title, a.first_image, d.overview
		from plan_seq s join attraction_info a
							 on s.content_id = a.content_id
						join attraction_description d
							 on s.content_id = d.content_id
		where s.plan_id = #{planId}
		order by s.plan_date, s.plan_seq;
	</select>
</mapper>